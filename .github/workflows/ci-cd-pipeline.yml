name: CI/CD Pipeline - Build and Deploy

on:
  push:
    branches: 
      - main
      - devops-build-deploy-code
  pull_request:
    branches: 
      - main
      - devops-build-deploy-code
  workflow_dispatch:

env:
  NODE_VERSION: '18.x'

jobs:
  validate-and-build:
    name: Validate Prompts and Build Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Check for Node.js dependencies
      id: check-nodejs
      run: |
        if [ -f "package.json" ]; then
          echo "has_nodejs=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Node.js project detected"
        else
          echo "has_nodejs=false" >> $GITHUB_OUTPUT
          echo "‚ÑπÔ∏è  No Node.js dependencies found (this is fine for documentation-only repos)"
        fi
      
    - name: Setup Node.js (if needed)
      if: steps.check-nodejs.outputs.has_nodejs == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install Node.js dependencies (if needed)
      if: steps.check-nodejs.outputs.has_nodejs == 'true'
      run: |
        echo "üì¶ Installing Node.js dependencies..."
        npm ci
    
    - name: Validate Repository Structure
      run: |
        echo "üîç Validating repository structure..."
        
        # Check for required directories
        if [ -d ".github/prompts" ]; then
          echo "‚úÖ .github/prompts directory exists"
        else
          echo "‚ùå .github/prompts directory missing"
          exit 1
        fi
        
        if [ -d "docs" ]; then
          echo "‚úÖ docs directory exists"
        else
          echo "‚ùå docs directory missing"
          exit 1
        fi
        
        if [ -d "scripts" ]; then
          echo "‚úÖ scripts directory exists"
        else
          echo "‚ùå scripts directory missing"
          exit 1
        fi
    
    - name: Validate Prompt Files
      run: |
        echo "üìã Validating prompt files..."
        
        # Count prompt files
        PROMPT_COUNT=$(find .github/prompts -name "*.prompt.md" 2>/dev/null | wc -l)
        echo "Found $PROMPT_COUNT prompt file(s)"
        
        if [ $PROMPT_COUNT -eq 0 ]; then
          echo "‚ö†Ô∏è  No prompt files found"
        else
          echo "‚úÖ Prompt files found"
          
          # List all prompt files
          echo ""
          echo "üìù Prompt files:"
          find .github/prompts -name "*.prompt.md" -exec basename {} \;
        fi
        
        # Validate each prompt file structure
        for file in .github/prompts/*.prompt.md; do
          if [ -f "$file" ]; then
            echo ""
            echo "Validating: $file"
            
            # Check for required sections
            if grep -q "^Title:" "$file" || grep -q "^# " "$file"; then
              echo "  ‚úÖ Has title"
            else
              echo "  ‚ö†Ô∏è  Missing title"
            fi
            
            if grep -q -i "goal" "$file" || grep -q -i "purpose" "$file"; then
              echo "  ‚úÖ Has goal/purpose"
            else
              echo "  ‚ö†Ô∏è  Missing goal/purpose"
            fi
            
            if grep -q -i "precondition" "$file" || grep -q -i "prerequisite" "$file"; then
              echo "  ‚úÖ Has preconditions"
            else
              echo "  ‚ö†Ô∏è  Missing preconditions"
            fi
          fi
        done
    
    - name: Validate PowerShell Scripts
      run: |
        echo "üîß Validating PowerShell scripts..."
        
        # Count PowerShell scripts
        PS_COUNT=$(find scripts -name "*.ps1" 2>/dev/null | wc -l)
        echo "Found $PS_COUNT PowerShell script(s)"
        
        if [ $PS_COUNT -gt 0 ]; then
          echo "‚úÖ PowerShell scripts found"
          
          # List all scripts
          echo ""
          echo "üìú PowerShell scripts:"
          find scripts -name "*.ps1" -exec basename {} \;
          
          # Basic syntax check (check for common errors)
          for script in scripts/**/*.ps1; do
            if [ -f "$script" ]; then
              echo ""
              echo "Checking: $script"
              
              # Check for basic PowerShell syntax
              if grep -q "^\$env:" "$script"; then
                echo "  ‚úÖ Contains environment variable usage"
              fi
              
              if grep -q "Write-Host" "$script"; then
                echo "  ‚úÖ Contains output statements"
              fi
            fi
          done
        fi
    
    - name: Validate Documentation
      run: |
        echo "üìö Validating documentation..."
        
        # Check README.md
        if [ -f "README.md" ]; then
          echo "‚úÖ README.md exists"
          
          # Check README size
          README_SIZE=$(wc -c < README.md)
          echo "  README.md size: $README_SIZE bytes"
          
          if [ $README_SIZE -gt 100 ]; then
            echo "  ‚úÖ README.md has content"
          else
            echo "  ‚ö†Ô∏è  README.md seems too small"
          fi
        else
          echo "‚ùå README.md missing"
          exit 1
        fi
        
        # Check for documentation in docs/
        DOC_COUNT=$(find docs -name "*.md" 2>/dev/null | wc -l)
        echo ""
        echo "Found $DOC_COUNT documentation file(s) in docs/"
        
        if [ $DOC_COUNT -gt 0 ]; then
          echo "‚úÖ Documentation files found"
          echo ""
          echo "üìÑ Documentation files:"
          find docs -name "*.md" -exec basename {} \;
        fi
    
    - name: Generate Build Report
      run: |
        echo "üìä Generating build report..."
        
        # Create build directory
        mkdir -p build-report
        
        # Generate report
        cat > build-report/BUILD_REPORT.md <<EOF
        # Build Report
        
        **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        **Branch**: ${GITHUB_REF#refs/heads/}
        **Commit**: ${GITHUB_SHA:0:7}
        **Triggered By**: ${GITHUB_ACTOR}
        
        ## Repository Structure
        
        \`\`\`
        $(tree -L 2 -I 'node_modules|.git' || find . -maxdepth 2 -not -path '*/\.*' -type d)
        \`\`\`
        
        ## Prompt Files
        
        $(find .github/prompts -name "*.prompt.md" -exec echo "- {}" \; 2>/dev/null || echo "No prompt files found")
        
        ## Documentation Files
        
        $(find docs -name "*.md" -exec echo "- {}" \; 2>/dev/null || echo "No documentation files found")
        
        ## PowerShell Scripts
        
        $(find scripts -name "*.ps1" -exec echo "- {}" \; 2>/dev/null || echo "No scripts found")
        
        ## Validation Status
        
        ‚úÖ All validations passed successfully
        
        ## Next Steps
        
        - Review prompt files for accuracy
        - Test PowerShell scripts in target environment
        - Verify documentation completeness
        
        ---
        *Generated by CI/CD Pipeline*
        EOF
        
        echo "‚úÖ Build report generated"
        cat build-report/BUILD_REPORT.md
    
    - name: Upload Build Report
      uses: actions/upload-artifact@v4
      with:
        name: build-report
        path: build-report/
        retention-days: 30
    
    - name: Create Deployment Package
      run: |
        echo "üì¶ Creating deployment package..."
        
        # Create deployment directory
        mkdir -p deployment-package
        
        # Copy essential files
        cp -r .github deployment-package/
        cp -r docs deployment-package/
        cp -r scripts deployment-package/
        cp README.md deployment-package/
        cp .gitignore deployment-package/ 2>/dev/null || true
        
        # Create deployment metadata
        cat > deployment-package/DEPLOYMENT_INFO.json <<EOF
        {
          "version": "1.0.${GITHUB_RUN_NUMBER}",
          "buildDate": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "branch": "${GITHUB_REF#refs/heads/}",
          "commit": "${GITHUB_SHA}",
          "commitShort": "${GITHUB_SHA:0:7}",
          "actor": "${GITHUB_ACTOR}",
          "workflow": "${GITHUB_WORKFLOW}",
          "runNumber": "${GITHUB_RUN_NUMBER}",
          "repository": "${GITHUB_REPOSITORY}"
        }
        EOF
        
        echo "‚úÖ Deployment package created"
        echo ""
        echo "Package contents:"
        ls -la deployment-package/
    
    - name: Upload Deployment Package
      uses: actions/upload-artifact@v4
      with:
        name: deployment-package
        path: deployment-package/
        retention-days: 90

  security-scan:
    name: Security and Quality Checks
    runs-on: ubuntu-latest
    needs: validate-and-build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Run Markdown Linting
      uses: DavidAnson/markdownlint-cli2-action@v14
      continue-on-error: true
      with:
        globs: |
          **/*.md
          !node_modules/**
    
    - name: Check for Sensitive Data
      run: |
        echo "üîê Scanning for sensitive data..."
        
        # Check for potential secrets or sensitive patterns
        echo "Checking for API keys, tokens, passwords..."
        
        # Define patterns to search for
        PATTERNS=(
          "password.*=.*['\"].*['\"]"
          "token.*=.*['\"].*['\"]"
          "api[_-]?key.*=.*['\"].*['\"]"
          "secret.*=.*['\"].*['\"]"
          "Bearer [A-Za-z0-9\-\._~\+\/]+=*"
          "AKIA[0-9A-Z]{16}"
        )
        
        FOUND_ISSUES=0
        
        for pattern in "${PATTERNS[@]}"; do
          if grep -r -i -E "$pattern" --exclude-dir=.git --exclude-dir=node_modules . 2>/dev/null; then
            echo "‚ö†Ô∏è  Potential sensitive data found matching pattern: $pattern"
            FOUND_ISSUES=$((FOUND_ISSUES + 1))
          fi
        done
        
        if [ $FOUND_ISSUES -eq 0 ]; then
          echo "‚úÖ No obvious sensitive data patterns detected"
        else
          echo "‚ö†Ô∏è  Found $FOUND_ISSUES potential issue(s) - please review"
          echo "Note: These may be false positives (e.g., in documentation)"
        fi
    
    - name: Validate File Permissions
      run: |
        echo "üîí Checking file permissions..."
        
        # Check for executable scripts
        echo "Executable files:"
        find . -type f -executable -not -path '*/\.git/*' || echo "No executable files found"
        
        echo ""
        echo "‚úÖ File permissions check complete"

  deploy:
    name: Deploy to Azure Web App
    runs-on: ubuntu-latest
    needs: [validate-and-build, security-scan]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/devops-build-deploy-code'
    permissions:
      contents: read
      id-token: write
    
    environment:
      name: production
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: deployment-package
        path: deployment-package/
    
    - name: Detect Tech Stack
      id: detect-stack
      run: |
        echo "üîç Detecting tech stack for Azure deployment..."
        
        # Detect Node.js
        if [ -f "package.json" ]; then
          echo "runtime=node" >> $GITHUB_OUTPUT
          NODE_VERSION=$(grep -oP '"node":\s*"\K[^"]+' package.json || echo "18")
          echo "runtime_version=NODE|$NODE_VERSION-lts" >> $GITHUB_OUTPUT
          echo "‚úÖ Detected: Node.js application"
        
        # Detect Python
        elif [ -f "requirements.txt" ] || [ -f "Pipfile" ] || [ -f "pyproject.toml" ]; then
          echo "runtime=python" >> $GITHUB_OUTPUT
          PYTHON_VERSION="3.11"
          if [ -f "runtime.txt" ]; then
            PYTHON_VERSION=$(cat runtime.txt | grep -oP 'python-\K[0-9.]+' || echo "3.11")
          fi
          echo "runtime_version=PYTHON|$PYTHON_VERSION" >> $GITHUB_OUTPUT
          echo "‚úÖ Detected: Python application"
        
        # Detect Java
        elif [ -f "pom.xml" ] || [ -f "build.gradle" ]; then
          echo "runtime=java" >> $GITHUB_OUTPUT
          echo "runtime_version=JAVA|17-java17" >> $GITHUB_OUTPUT
          echo "‚úÖ Detected: Java application"
        
        # Detect .NET
        elif ls *.csproj 1>/dev/null 2>&1 || ls *.fsproj 1>/dev/null 2>&1; then
          echo "runtime=dotnet" >> $GITHUB_OUTPUT
          echo "runtime_version=DOTNETCORE|8.0" >> $GITHUB_OUTPUT
          echo "‚úÖ Detected: .NET application"
        
        # Detect PHP
        elif [ -f "composer.json" ] || [ -f "index.php" ]; then
          echo "runtime=php" >> $GITHUB_OUTPUT
          echo "runtime_version=PHP|8.2" >> $GITHUB_OUTPUT
          echo "‚úÖ Detected: PHP application"
        
        # Detect Ruby
        elif [ -f "Gemfile" ] || [ -f "config.ru" ]; then
          echo "runtime=ruby" >> $GITHUB_OUTPUT
          echo "runtime_version=RUBY|3.2" >> $GITHUB_OUTPUT
          echo "‚úÖ Detected: Ruby application"
        
        # Static site (documentation only)
        else
          echo "runtime=static" >> $GITHUB_OUTPUT
          echo "runtime_version=NODE|18-lts" >> $GITHUB_OUTPUT
          echo "‚ÑπÔ∏è  Detected: Static site (will use Node.js for hosting)"
        fi
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Create or Update Azure Web App
      id: create-webapp
      run: |
        echo "üîß Creating/updating Azure Web App..."
        
        # Set variables
        RESOURCE_GROUP="${{ secrets.AZURE_RESOURCE_GROUP }}"
        WEBAPP_NAME="${{ secrets.AZURE_WEBAPP_NAME }}"
        LOCATION="${{ secrets.AZURE_LOCATION || 'eastus' }}"
        RUNTIME="${{ steps.detect-stack.outputs.runtime_version }}"
        SKU="${{ secrets.AZURE_SKU || 'F1' }}"
        
        echo "Configuration:"
        echo "  Resource Group: $RESOURCE_GROUP"
        echo "  Web App Name: $WEBAPP_NAME"
        echo "  Location: $LOCATION"
        echo "  Runtime: $RUNTIME"
        echo "  SKU: $SKU"
        
        # Create resource group if it doesn't exist
        az group create --name $RESOURCE_GROUP --location $LOCATION || true
        
        # Check if App Service Plan exists
        PLAN_EXISTS=$(az appservice plan list --resource-group $RESOURCE_GROUP --query "[?name=='${WEBAPP_NAME}-plan'].name" -o tsv)
        
        if [ -z "$PLAN_EXISTS" ]; then
          echo "Creating new App Service Plan..."
          az appservice plan create \
            --name ${WEBAPP_NAME}-plan \
            --resource-group $RESOURCE_GROUP \
            --location $LOCATION \
            --sku $SKU \
            --is-linux
        else
          echo "‚úÖ App Service Plan already exists"
        fi
        
        # Check if Web App exists
        WEBAPP_EXISTS=$(az webapp list --resource-group $RESOURCE_GROUP --query "[?name=='$WEBAPP_NAME'].name" -o tsv)
        
        if [ -z "$WEBAPP_EXISTS" ]; then
          echo "Creating new Web App..."
          az webapp create \
            --name $WEBAPP_NAME \
            --resource-group $RESOURCE_GROUP \
            --plan ${WEBAPP_NAME}-plan \
            --runtime "$RUNTIME"
        else
          echo "‚úÖ Web App already exists, updating configuration..."
          az webapp config set \
            --name $WEBAPP_NAME \
            --resource-group $RESOURCE_GROUP \
            --linux-fx-version "$RUNTIME"
        fi
        
        # Configure Web App settings
        az webapp config appsettings set \
          --name $WEBAPP_NAME \
          --resource-group $RESOURCE_GROUP \
          --settings \
            SCM_DO_BUILD_DURING_DEPLOYMENT=true \
            WEBSITE_RUN_FROM_PACKAGE=1 \
            DEPLOYMENT_BRANCH="${GITHUB_REF#refs/heads/}" \
            DEPLOYMENT_COMMIT="${GITHUB_SHA:0:7}" \
            BUILD_NUMBER="${GITHUB_RUN_NUMBER}"
        
        echo "‚úÖ Azure Web App configured successfully"
        echo "webapp_url=https://${WEBAPP_NAME}.azurewebsites.net" >> $GITHUB_OUTPUT
    
    - name: Prepare Deployment Package
      run: |
        echo "üì¶ Preparing deployment package..."
        
        # Create deployment directory
        mkdir -p deploy
        
        if [ "${{ steps.detect-stack.outputs.runtime }}" == "static" ]; then
          # For static sites, create a simple Node.js server
          cp -r deployment-package/* deploy/
          
          cat > deploy/server.js <<'EOF'
        const express = require('express');
        const path = require('path');
        const app = express();
        const port = process.env.PORT || 8080;

        app.use(express.static(__dirname));
        app.get('*', (req, res) => {
          res.sendFile(path.join(__dirname, 'index.html'));
        });

        app.listen(port, () => {
          console.log(`Server running on port ${port}`);
        });
        EOF
          
          cat > deploy/package.json <<EOF
        {
          "name": "mcp-server-prompts-docs",
          "version": "1.0.0",
          "description": "MCP Server & Prompts Documentation",
          "main": "server.js",
          "scripts": {
            "start": "node server.js"
          },
          "dependencies": {
            "express": "^4.18.2"
          },
          "engines": {
            "node": ">=18.0.0"
          }
        }
        EOF
          
          # Create index.html
          cat > deploy/index.html <<'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>MCP Server & Prompts Documentation</title>
            <style>
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    max-width: 1200px;
                    margin: 0 auto;
                    padding: 40px 20px;
                    line-height: 1.6;
                    color: #24292e;
                    background: #f6f8fa;
                }
                .container { background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
                h1 { color: #0366d6; margin-bottom: 10px; }
                .subtitle { color: #586069; margin-bottom: 30px; }
                .card {
                    border: 1px solid #e1e4e8;
                    border-radius: 6px;
                    padding: 24px;
                    margin: 20px 0;
                    background: #f6f8fa;
                }
                .button {
                    display: inline-block;
                    padding: 12px 24px;
                    background: #0366d6;
                    color: white;
                    text-decoration: none;
                    border-radius: 6px;
                    margin: 8px 5px 8px 0;
                    font-weight: 600;
                    transition: background 0.2s;
                }
                .button:hover { background: #0256c7; }
                .status { 
                    display: inline-block;
                    padding: 5px 12px;
                    border-radius: 12px;
                    font-size: 14px;
                    font-weight: 600;
                    background: #28a745;
                    color: white;
                }
                ul { list-style: none; padding: 0; }
                li { padding: 8px 0; border-bottom: 1px solid #e1e4e8; }
                li:last-child { border-bottom: none; }
                code { 
                    background: #f6f8fa; 
                    padding: 3px 6px; 
                    border-radius: 3px; 
                    font-family: 'Courier New', monospace;
                    font-size: 14px;
                }
                .footer {
                    margin-top: 60px;
                    padding-top: 30px;
                    border-top: 2px solid #e1e4e8;
                    text-align: center;
                    color: #586069;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üöÄ MCP Server & Prompts</h1>
                <p class="subtitle">Model Context Protocol Prompts for DevOps Workflows</p>
                <p class="status">‚úÖ Deployed on Azure</p>
                
                <div class="card">
                    <h2>üìã Available Prompts</h2>
                    <ul>
                        <li><strong>Azure DevOps: Assign Current Sprint Task</strong> - Automatically assign work items from current sprint</li>
                        <li><strong>GitHub CI/CD Pipeline Generator</strong> - Auto-detect tech stack and generate complete CI/CD pipelines</li>
                        <li><strong>Azure DevOps Work Item Management</strong> - Comprehensive work item operations</li>
                        <li><strong>Playwright Test Automation</strong> - Run and diagnose Playwright tests</li>
                        <li><strong>MySQL Query Execution</strong> - Execute and manage database queries</li>
                    </ul>
                </div>
                
                <div class="card">
                    <h2>üìö Documentation</h2>
                    <p>Comprehensive guides and references for all prompts and workflows.</p>
                    <a href="/docs/QUICK_REFERENCE.md" class="button">Quick Reference</a>
                    <a href="/docs/github-cicd-pipeline-generator.md" class="button">CI/CD Guide</a>
                    <a href="/docs/CREATION_SUMMARY.md" class="button">Implementation</a>
                </div>
                
                <div class="card">
                    <h2>üîß Setup Scripts</h2>
                    <p>PowerShell scripts to configure your environment:</p>
                    <ul>
                        <li><code>set-azure-devops-env.ps1</code> - Configure Azure DevOps environment variables</li>
                        <li><code>set-github-cicd-env.ps1</code> - Configure GitHub CI/CD environment variables</li>
                    </ul>
                </div>
                
                <div class="card">
                    <h2>üîó Quick Links</h2>
                    <a href="https://github.com/cgjdparashar/mcp-server-and-prompts" class="button">GitHub Repository</a>
                    <a href="https://github.com/cgjdparashar/mcp-server-and-prompts/actions" class="button">Build Status</a>
                    <a href="/DEPLOYMENT_INFO.json" class="button">Deployment Info</a>
                </div>
                
                <div class="footer">
                    <p><strong>Deployed on Azure Web Apps</strong></p>
                    <p>Built with ‚ù§Ô∏è using GitHub Actions | ¬© 2025</p>
                </div>
            </div>
        </body>
        </html>
        EOF
        else
          # For applications with runtime, copy the built artifacts
          cp -r deployment-package/* deploy/
        fi
        
        echo "‚úÖ Deployment package prepared"
        ls -la deploy/
    
    - name: Deploy to Azure Web App
      id: deploy-to-webapp
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
        package: deploy
    
    - name: Deployment Summary
      run: |
        echo "üéâ Deployment completed successfully!"
        echo ""
        echo "üìä Deployment Details:"
        echo "  - URL: https://${{ secrets.AZURE_WEBAPP_NAME }}.azurewebsites.net"
        echo "  - Runtime: ${{ steps.detect-stack.outputs.runtime_version }}"
        echo "  - Version: 1.0.${GITHUB_RUN_NUMBER}"
        echo "  - Branch: ${GITHUB_REF#refs/heads/}"
        echo "  - Commit: ${GITHUB_SHA:0:7}"
        echo ""
        echo "‚úÖ Your application is now live on Azure!"

  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [validate-and-build, security-scan, deploy]
    if: always()
    
    steps:
    - name: Build Status Summary
      run: |
        echo "üì¨ CI/CD Pipeline Summary"
        echo "=========================="
        echo ""
        echo "Build Status: ${{ needs.validate-and-build.result }}"
        echo "Security Scan: ${{ needs.security-scan.result }}"
        echo "Deployment: ${{ needs.deploy.result }}"
        echo ""
        
        if [ "${{ needs.validate-and-build.result }}" == "success" ] && \
           [ "${{ needs.security-scan.result }}" == "success" ] && \
           [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "‚úÖ All jobs completed successfully!"
          echo "üéâ Pipeline Status: SUCCESS"
        else
          echo "‚ö†Ô∏è  Some jobs failed or were skipped"
          echo "üìã Pipeline Status: COMPLETED WITH ISSUES"
        fi
        
        echo ""
        echo "Workflow run: https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
